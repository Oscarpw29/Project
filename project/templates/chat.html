{% extends 'base.html' %}

{% block content %}

    <h1>Chat with {{ recipient.username }}</h1>

    <div id="chat-messages">
        {% for message in messages %}
            <li>
                {% if message.sender == current_user %}
                    You: {{ message.message }}
                {% else %}
                    {{ message.sender.username }}: {{ message.message }}
                {% endif %}
            </li>
        {% endfor %}
    </div> 

    <form id="message-form" method="POST">
        <label for="message-input"></label><input type="text" id="message-input" placeholder="Type your message">
        <button type="submit">Send</button>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const recipientUsername = '{{ recipient.username }}'; 

        socket.emit('join', recipientUsername); 

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value;
            if (message) {
                socket.emit('message', { message: message, sender: '{{ user.username }}', recipient: recipientUsername }); 
                messageInput.value = '';
            }
        });

        socket.on('message', (data) => {
            const messageItem = document.createElement('li');
            messageItem.textContent = `${data.sender}: ${data.data}`;
            chatMessages.appendChild(messageItem);
        });
    </script>
{% endblock %}